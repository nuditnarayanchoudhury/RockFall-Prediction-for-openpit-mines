#!/usr/bin/env python3
"""
Setup script for AI Rockfall Prediction System - Automatic Alerts
This script helps configure email and SMS alerts for the system
"""

import os
import sys
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
import smtplib

def print_banner():
    """Print setup banner"""
    print("=" * 70)
    print("üö® AI Rockfall Prediction System - Alert Setup")
    print("=" * 70)
    print()

def test_email_config(email_user, email_password, smtp_server, smtp_port):
    """Test email configuration"""
    try:
        print(f"üìß Testing email configuration for {email_user}...")
        
        # Create test message
        msg = MIMEMultipart()
        msg['From'] = email_user
        msg['To'] = email_user  # Send test email to self
        msg['Subject'] = "üö® Rockfall Alert System - Test Email"
        
        body = """
        <html>
        <body>
        <h2>‚úÖ Email Configuration Test Successful!</h2>
        <p>Your AI Rockfall Prediction System is now configured for automatic email alerts.</p>
        <p><strong>System Details:</strong></p>
        <ul>
        <li>SMTP Server: {}</li>
        <li>Port: {}</li>
        <li>From Email: {}</li>
        </ul>
        <p>This test confirms that high-risk alerts will be automatically sent via email.</p>
        <hr>
        <small>AI-Based Rockfall Prediction System - Smart India Hackathon Project</small>
        </body>
        </html>
        """.format(smtp_server, smtp_port, email_user)
        
        msg.attach(MIMEText(body, 'html'))
        
        # Send test email
        with smtplib.SMTP(smtp_server, int(smtp_port)) as server:
            server.starttls()
            server.login(email_user, email_password)
            server.send_message(msg)
        
        print("‚úÖ Email test successful! Check your inbox for confirmation.")
        return True
        
    except Exception as e:
        print(f"‚ùå Email test failed: {e}")
        print("üí° Common issues:")
        print("   - Enable 2-factor authentication for Gmail")
        print("   - Use an App Password instead of your regular password")
        print("   - Check SMTP server and port settings")
        return False

def setup_email():
    """Setup email configuration"""
    print("üìß Email Configuration Setup")
    print("-" * 30)
    
    print("For Gmail users:")
    print("1. Enable 2-factor authentication on your Google account")
    print("2. Generate an 'App Password' in Google Account settings")
    print("3. Use the App Password here (not your regular password)")
    print()
    
    email_user = input("Enter your email address: ").strip()
    email_password = input("Enter your email password/app password: ").strip()
    
    smtp_server = input(f"SMTP Server (default: smtp.gmail.com): ").strip()
    if not smtp_server:
        smtp_server = "smtp.gmail.com"
    
    smtp_port = input(f"SMTP Port (default: 587): ").strip()
    if not smtp_port:
        smtp_port = "587"
    
    print()
    test_email = input("Test email configuration now? (y/n): ").strip().lower()
    
    if test_email == 'y':
        test_email_config(email_user, email_password, smtp_server, smtp_port)
    
    return {
        'EMAIL_USER': email_user,
        'EMAIL_PASSWORD': email_password,
        'SMTP_SERVER': smtp_server,
        'SMTP_PORT': smtp_port
    }

def setup_recipients():
    """Setup alert recipients"""
    print()
    print("üë• Alert Recipients Setup")
    print("-" * 25)
    print()
    print("Enter email addresses for different alert levels:")
    print("(You can enter multiple emails separated by commas)")
    print()
    
    emergency_emails = input("Emergency contacts (HIGH risk alerts): ").strip()
    manager_emails = input("Management contacts (MEDIUM/HIGH alerts): ").strip()
    operator_emails = input("Operations team (ALL alerts): ").strip()
    
    return {
        'EMERGENCY_EMAILS': emergency_emails,
        'MANAGER_EMAILS': manager_emails,
        'OPERATOR_EMAILS': operator_emails
    }

def create_env_file(config):
    """Create .env file with configuration"""
    env_content = f"""# AI Rockfall Prediction System - Generated Configuration
# Generated by setup_alerts.py

# Email Configuration
EMAIL_USER={config['EMAIL_USER']}
EMAIL_PASSWORD={config['EMAIL_PASSWORD']}
SMTP_SERVER={config['SMTP_SERVER']}
SMTP_PORT={config['SMTP_PORT']}

# Alert Recipients
EMERGENCY_EMAILS={config['EMERGENCY_EMAILS']}
MANAGER_EMAILS={config['MANAGER_EMAILS']}
OPERATOR_EMAILS={config['OPERATOR_EMAILS']}

# SMS Configuration (optional - configure if you have Twilio)
# TWILIO_SID=your_twilio_account_sid
# TWILIO_TOKEN=your_twilio_auth_token
# TWILIO_PHONE=+1234567890

# Monitoring Settings
ALERT_CHECK_INTERVAL=60
ALERT_COOLDOWN=1800
HIGH_RISK_THRESHOLD=0.7
MEDIUM_RISK_THRESHOLD=0.4

# Database
SECRET_KEY=rockfall_prediction_system_2024_secret_key
DATABASE_URL=sqlite:///rockfall_system.db
"""
    
    with open('.env', 'w') as f:
        f.write(env_content)
    
    print("‚úÖ Configuration saved to .env file")

def main():
    """Main setup function"""
    print_banner()
    
    print("This script will help you configure automatic email/SMS alerts")
    print("for when HIGH risk conditions are detected at mining sites.")
    print()
    
    # Check if .env already exists
    if os.path.exists('.env'):
        overwrite = input("‚ö†Ô∏è  .env file already exists. Overwrite? (y/n): ").strip().lower()
        if overwrite != 'y':
            print("Setup cancelled.")
            return
    
    try:
        # Setup email
        email_config = setup_email()
        
        # Setup recipients
        recipient_config = setup_recipients()
        
        # Combine configurations
        full_config = {**email_config, **recipient_config}
        
        # Create .env file
        create_env_file(full_config)
        
        print()
        print("=" * 70)
        print("üéâ Setup Complete!")
        print("=" * 70)
        print()
        print("Your automatic alert system is now configured:")
        print(f"‚úÖ Email alerts: {email_config['EMAIL_USER']}")
        print(f"‚úÖ Emergency contacts: {recipient_config['EMERGENCY_EMAILS']}")
        print(f"‚úÖ Check interval: 60 seconds")
        print(f"‚úÖ Alert threshold: HIGH risk (0.7+)")
        print()
        print("Next steps:")
        print("1. Run: python app_with_auth.py")
        print("2. The system will automatically monitor all mines")
        print("3. HIGH risk alerts will be sent automatically via email")
        print()
        print("üîß To configure SMS alerts, edit the .env file and add Twilio credentials")
        print()
        
    except KeyboardInterrupt:
        print("\n\nSetup cancelled by user.")
    except Exception as e:
        print(f"\n‚ùå Setup failed: {e}")

if __name__ == '__main__':
    main()
